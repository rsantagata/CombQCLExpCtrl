<!DOCTYPE html>
<meta charset="utf-8">

<head>
    <title>DDS INTERFACE</title>
    <link rel="stylesheet" type="text/css" href="css/paritycrusherstyle.css">
    <!--Script references. -->
    <!--Reference the jQuery library. -->
    <script src="Scripts/jquery-2.2.3.min.js"></script>
    <!--Reference the SignalR library. -->
    <script src="Scripts/jquery.signalR-2.2.0.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="signalr/hubs"></script>
    <!--Add script to plot some data.-->
    <script src="https://cdn.plot.ly/plotly-latest.js"></script>
    <script src="js/plotlyplot.js" type="text/javascript"></script>
    <style type="text/css">
        .auto-style1 {
            font-size: small;
        }

        #ScanStart {
            width: 80px;
        }

        #ScanEnd {
            width: 80px;
        }

        #ScanHoldValue {
            width: 80px;
        }

        #NumberOfPoints {
            width: 80px;
        }

        #Sleep {
            width: 80px;
        }
    </style>
</head>

<body>
    <header>DDS INTERFACE</header>

    <section class="console">
        <article>
            <label>Console</label><br /><br />
            <textarea id="localconsole" style="width:100%; height:75px; border: 1px solid black" readonly></textarea>
        </article>
    </section>

    <section class="controlpanel">
        <label>Single Output Control</label><br />

        <article id="movecontainer">
            current DDS Frequency: 
            <input type="text" name="MoveFrom" id="MoveFrom" value="150"> MHz <br /> 
            target DDS Frequency:
            <input type="text" name="MoveTo" id="MoveTo" value="250"> MHz <br /> 
            <input type="button" id="gobutton" value="Go" />
        </article><br />

        <label>Scan Control</label><br />

        <article id="startstopcontainer">
            <input type="button" id="startbutton" value="Start" />
            <input type="button" id="stopbutton" value="Stop" />
        </article>

        <article id="numberofpointscontainer">
            <form name="numberofpointsform" id="numberofpointsform">
                Number of data points:
                <input type="text" name="NumberOfPoints" id="NumberOfPoints" value="100">
                <br />

                Sample loop rest interval [ms]:
                <input type="text" name="Sleep" id="Sleep" value="5">
                <br />

                <input type="checkbox" name="eosstopcheckbox" id="eosstopcheckbox" value="eosStop" />Stop on end-of-Scan
            </form>
        </article>


        <article id="scanboolcontainer">

            <label>Scan Bool</label><br />
            <form name="scanboolform" id="scanparamsform">
                Scan:
                <select name="ScanBool" id="ScanBool">
                    <option selected>true</option>
                    <option>false</option>
                </select>
                (hold at:
                <input type="text" name="ScanHoldValue" id="ScanHoldValue" value="200">
                MHz if false)
                <br />
            </form>
        </article>

        <article id="scanrangecontainer">
            <form name="scanrangeform" id="scanrangeform">
                <label>Scan Parameters (ignore if Scan Bool = false)</label><br />
                <br />
                <label>Start frequency</label>
                <input type="text" name="ScanStart" id="ScanStart" value="150">
                <label id="frequnitslabel1">MHz to DDS</label>
                <br />
                <label>Stop frequency</label>
                <input type="text" name="ScanEnd" id="ScanEnd" value="250">
                <label id="frequnitslabel2">MHz to DDS</label>
                <br />

                External factor 'm':
                <input type="text" name="ExternalFactor" id="ExternalFactor" value="64">
                <input type="button" id="converttoddsunitsbutton" value="Convert to DDS units" />
                <br />

                <br />
                <label> Warning: allowed values are  </label><br />
                <label> f<sub>min</sub> = 125 MHz <space> < <space> f<sub>DDS</sub></space> < <space>f<sub>max</sub> = 275 MHz </label><br />
                <label> 64 x f<sub>min</sub> = 8 GHz <space> < <space> 64 x f<sub>DDS</sub> </space> < <space>64 x f<sub>max</sub> = 17.6 GHz</label><br />
                <br />
            </form>
        </article>


        <article id="daqmxparamscontainer">
            <label>DAQmx Parameters</label><br />
            <form name="daqmxparamsform" id="daqmxexpparamsform">
                Auto-trigger:
                <select name="AutoStart" id="AutoStart">
                    <option selected>true</option>
                    <option>false</option>
                </select>
            </form>
        </article>

    </section>

    <section class="datadisplay">

        <article>
            <article class="plot" id="plot"></article>
            <input type="button" id="clearplotbutton" value="Clear" />
            <label>
                Plot with x-axis as:<select name="xaxisselect" id="xaxisselect">
                    <option selected>DDS Frequency</option>
                    <option>Acquisition Order</option>
                    <option>Frequency * External Factor</option>
                </select>
            </label>

        </article>

        <article>
            <label>Save/Export</label><br /><br />
            <input type="button" id="exportdatabutton" value="Export to" />
            <select name="exportformatselect" id="exportformatselect">
                <option selected>TSV</option>
                <option>CSV</option>
                <option>Mathematica</option>
                <option>JSON</option>
            </select>
            <input type="button" id="copydatabutton" value="Copy to clipboard" />
            <br>
            <a id="downloadlink" href="" target="_blank" hidden>Data ready for export: right-click here & select "Save target as" to download.</a><br />
            <textarea id="rawData" style="width: 90%; height:100px; padding: 2px; border: 1px solid black" readonly></textarea>
        </article>

    </section>




    <script type="text/javascript">

        $(function () {

            $('#localconsole').val("Hi! Connecting to experiment now. Please wait.");
            // Declare a proxy to reference the hub.
            var expHub = $.connection.experimentHub;

            // Create a function that the hub can call to plot the data.
            expHub.client.pushLatestData = function (data) {

                //parse to send to plotting functions.
                var jData = JSON.parse(data);
                //Keep data and experimental parameters on screen:

                clearData();
                var plot = document.getElementById("plot");

                plotDataWithRightAxes(plot, jData);

            };

            expHub.client.pushAllDataToTextArea = function (data) {
                $('#rawData').val(data);
            };

            //The console, which the hub can call to print information
            expHub.client.toConsole = function (s) {
                $('#localconsole').val($('#localconsole').val() + '\n' + s);
                $('#localconsole').scrollTop($('#localconsole')[0].scrollHeight);
            };

            //This is called by the server once the mma Notebook is ready
            expHub.client.displayDownloadLink = function (link) {
                $('#downloadlink').attr({ href: link, target: '_blank' });
                //$('#downloadlink').attr("download", link.split('\\').pop());
                $('#downloadlink').show();
            };

            // Start the connection! Herein are start and stop functions, which interact with the experiment.
            $.connection.hub.start().done(function () {

                $('#startbutton').click(function () {

                    var expParams = getExperimentParameters();
                    //Getting plot ready.
                    initialisePlot(document.getElementById("plot"), expParams.ScanParams.ScanParameterName, expParams.DAQmx.AINames);

                    // Call the Start method on the hub.
                    expHub.server.startExperiment(JSON.stringify(getExperimentParameters()));

                });

                $('#stopbutton').click(function () {
                    // Call the Stop method on the hub.
                    expHub.server.stopExperiment();
                });

                $('#converttoddsunitsbutton').click(function () {
                    document.querySelector('#ScanStart').value = document.querySelector('#ScanStart').value / document.querySelector('#ExternalFactor').value;
                    document.querySelector('#ScanEnd').value = document.querySelector('#ScanEnd').value / document.querySelector('#ExternalFactor').value;
                    document.querySelector('#frequnitslabel1').textContent = "MHz (converted)";
                    document.querySelector('#frequnitslabel2').textContent = "MHz (converted)";
                });

                $('#clearplotbutton').click(function () {
                    //Clears data locally in browser
                    clearData();
                });

                $('#exportdatabutton').click(function () {
                    expHub.server.saveExperiment($('#exportformatselect').val());
                });

                //A slightly cheezy way of gently moving the DDS frequency to avoid unlocking.
                //Makes a single mock scan that doesn't acquire any data. 
                //Make sure the number of points corresponds to a 'safe' frequency interval.
                //ATM, there is no verification process and the DDS never returns.
                //Also, the start of the 'move' is unknown (to program), so it needs to be (initially) put in by hand.
                //To improve on this, make communication to DDS two way so we can to query the 'start' frequency.
                $('#gobutton').click(function () {
                    var expParams = getExperimentParameters();
                    expParams.ScanParams.AcquireDataDuringScan = false;
                    expParams.ScanParams.StopOnEOS = true;
                    expParams.ScanParams.ScanStart = parseFloat(document.querySelector('#MoveFrom').value);
                    expParams.ScanParams.ScanEnd = parseFloat(document.querySelector('#MoveTo').value);
                    expParams.ScanParams.NumberOfPoints = Math.abs(Math.round(1 / 2 * (expParams.ScanParams.ScanEnd - expParams.ScanParams.ScanStart))); //delta F of 2MHz
                    // Call the Start method on the hub.
                    expHub.server.startExperiment(JSON.stringify(getExperimentParameters()));

                    // So UI remembers end point of previous move.
                    document.querySelector('#MoveFrom').value = expParams.ScanParams.ScanEnd; 


                });

            });
        });

        //Clears data in plot
        var clearData = function () {
            deleteData(document.getElementById("plot"));
        };

        //Manipulating the data once it's taken.
        var copyButton = document.querySelector('#copydatabutton');
        copyButton.addEventListener('click', function (event) {
            var d = document.querySelector('#rawData');
            var range = document.createRange();
            range.selectNode(d);
            window.getSelection().addRange(range);

            var success_bool = document.execCommand('copy');

            window.getSelection().removeRange(range);
        });

        //Gets parameters on UI
        var getExperimentParameters = function () {
            //Stuff that doesn't change very often can be hardcoded here.
            var params = {
                'DAQmx': {
                    'AINames': ['dc', '1f', '2f'],
                    'AIAddresses': ['/dev1/ai1', '/dev1/ai2', '/dev1/ai3'],
                    'AutoStart': document.querySelector('#AutoStart').value,
                    'TriggerAddress': '/dev1/PFI0',
                    'SampleRate': 10000,
                    'NumberOfSamplesPerIntegrationTime': 1
                },

                'DDS': {
                    //'DDSAddress': 'ASRL4::INSTR'
                    'DDSAddress': 'ASRL3::INSTR'
                },

                'ScanParams': {
                    'ScanStart': document.querySelector('#ScanStart').value,
                    'ScanEnd': document.querySelector('#ScanEnd').value,
                    'NumberOfPoints': document.querySelector('#NumberOfPoints').value,
                    'HoldValue': document.querySelector('#ScanHoldValue').value,
                    'Sleep': document.querySelector('#Sleep').value,
                    'ScanParameterName': 'Frequency [Hz]',
                    'AcquireDataDuringScan': true,
                    'StopOnEOS': document.querySelector('#eosstopcheckbox').checked ? true : false
                },
                // Put all misc. parameters / comments / experimental conditions in here
                'ExternalParams': {
                    'Comments': "Empty comment",
                    'ExternalFactor': document.querySelector('#ExternalFactor').value
                }

            };


            //Creates the ramp to send to the experiment.

            var makeScanParameterValues = function () {
                //Redundant, but makes the code below easier to read.
                var factor = parseFloat(params.ExternalParams.MultiplicationFactor);
                var start = parseFloat(params.ScanParams.ScanStart);
                var end = parseFloat(params.ScanParams.ScanEnd);
                var hold = parseFloat(params.ScanParams.HoldValue);
                var points = parseFloat(params.ScanParams.NumberOfPoints);

                //DDS SCAN
                if (document.querySelector('#ScanBool').value == "true") {
                    if ((start > 125) && (end < 275)) {
                        params.ScanParams.ScanParameterValues = function () {
                            var vals = [], dv = (end - start) / points;
                            for (var i = 0; i < points / 2; i++) {
                                vals.push((2 * i * dv + start) * 1000000);
                            }
                            for (var i = 0; i < points / 2; i++) {
                                vals.push((end - 2 * i * dv) * 1000000);
                            }
                            return vals;
                        }();
                    }
                }

                    //DDS HOLD
                else if (document.querySelector('#ScanBool').value == "false") {
                    if ((hold > 125) && (hold < 275)) {
                        params.ScanParams.ScanParameterValues = function () {
                            var vals = [];
                            for (var i = 0; i < points ; i++) {
                                vals.push(hold * 1000000);
                            }
                            return vals;
                        }();
                    }
                };

            };
            makeScanParameterValues();
            return params;
        };


    </script>
</body>
