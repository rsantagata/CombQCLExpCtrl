<!DOCTYPE html>
<meta charset="utf-8">

<head>
    <title>DDS INTERFACE</title>
    <link rel="stylesheet" type="text/css" href="css/paritycrusherstyle.css">
    <!--Script references. -->
    <!--Reference the jQuery library. -->
    <script src="Scripts/jquery-2.2.3.min.js"></script>
    <!--Reference the SignalR library. -->
    <script src="Scripts/jquery.signalR-2.2.0.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="signalr/hubs"></script>
    <!--Add script to plot some data.-->
    <script src="https://cdn.plot.ly/plotly-latest.js"></script>
    <script src="js/plotlyplot2.js" type="text/javascript"></script>
    <style type="text/css">
        .auto-style1 {
            font-size: small;
        }

        #ScanStart {
            width: 80px;
        }

        #ScanEnd {
            width: 80px;
        }

        #ScanHoldValue {
            width: 80px;
        }

        #NumberOfPoints {
            width: 80px;
        }

        #Sleep {
            width: 80px;
        }
    </style>
</head>

<body>
    <header>DDS INTERFACE</header>

    <section class="console">
        <article>
            <label>Console</label><br /><br />
            <textarea id="localconsole" style="width:100%; height:75px; border: 1px solid black" readonly></textarea>
        </article>
    </section>

    <section class="controlpanel">

        <article id="startstopcontainer">
            <label>Experiment Control</label><br />
            <input type="button" id="startbutton" value="Start" />
            <input type="button" id="stopbutton" value="Stop" />
        </article>

        <article id="scanparamscontainer">

            <label>Scan Parameters</label><br />
            <form name="scanparamsform" id="scanparamsform">

                </label>
                Scan:
                <select name="ScanBool" id="ScanBool">
                    <option selected>true</option>
                    <option>false</option>
                </select>
                <br />

                External factor 'm':
                <input type="text" name="ExternalFactor" id="ExternalFactor" value="64">
                <input type="button" id="converttoddsunitsbutton" value="Convert" />
                <br>

                <br>
                <label>INPUT FREQUENCIES</label><br />
                <label><span class="auto-style1"> !!! allowed values!!! </span> </label><br />
                <label><span class="auto-style1"> 125 MHz < <space>f<sub>DDS</sub></space> < 275 MHz </span> </label><br />
                <label><span class="auto-style1"> 8 GHz < <space>m x f<sub>DDS</sub></space> < 17,6 GHz </span> </label><br />

                <br>
                Start frequency [MHz]:
                <input type="text" name="ScanStart" id="ScanStart" value="150">

                <br>
                Stop frequency [MHz]:
                <input type="text" name="ScanEnd" id="ScanEnd" value="250">

                <br>
                Fixed frequency [MHz]:
                <input type="text" name="ScanHoldValue" id="ScanHoldValue" value="200">
                <br />

                <br>
                Number of data points:
                <input type="text" name="NumberOfPoints" id="NumberOfPoints" value="100">

                <br>
                Sample loop rest interval [ms]:
                <input type="text" name="Sleep" id="Sleep" value="5">



                <br>
                <label>
                    <input type="checkbox" name="eosstopcheckbox" id="eosstopcheckbox" value="eosStop" />Stop on end-of-Scan
            </form>
        </article>

        <article id="daqmxparamscontainer">
            <label>DAQmx Parameters</label><br />
            <form name="daqmxparamsform" id="daqmxexpparamsform">
                Auto-trigger:
                <select name="AutoStart" id="AutoStart">
                    <option selected>true</option>
                    <option>false</option>
                </select>
            </form>
        </article>

        <article id="lockincontainer">
            <label>Lock-in Parameters</label><br />
            <form name="lockinparamsform" id="lockinparamsform">
                Demodulate signal:
                <select name="demodulate" id="Demodulate">
                    <option>true</option>
                    <option selected>false</option>
                </select>
                <br>
                Modulation frequency:
                <input type="text" name="ModulationFrequency" id="ModulationFrequency" value="1000">
                <br>
                Max harmonic:
                <input type="text" name="harmonic" id="Harmonic" value="1">
                <br>
            </form>
        </article>

    </section>

    <section class="datadisplay">

        <article>
            <article class="plot" id="plot"></article>
            <input type="button" id="clearplotbutton" value="Clear" />
            <label>
                Plot with x-axis as:<select name="xaxisselect" id="xaxisselect">
                    <option selected>DDS Frequency</option>
                    <option>Acquisition Order</option>
                    <option>Frequency * External Factor</option>
                </select>
            </label>

        </article>

        <article>
            <label>Save/Export</label><br /><br />
            <input type="button" id="toevernotebutton" value="Backup to Evernote" />
            <input type="button" id="exportdatabutton" value="Export to" />
            <select name="exportformatselect" id="exportformatselect">
                <option selected>TSV</option>
                <option>CSV</option>
                <option>Mathematica</option>
                <option>JSON</option>
            </select>
            <input type="button" id="copydatabutton" value="Copy to clipboard" />
            <br>
            <a id="downloadlink" href="" target="_blank" hidden>Data ready for export: right-click here & select "Save target as" to download.</a><br />
            <textarea id="rawData" style="width: 90%; height:100px; padding: 2px; border: 1px solid black" readonly></textarea>
        </article>

    </section>




    <script type="text/javascript">

        $(function () {

            $('#localconsole').val("Hi! Connecting to experiment now. Please wait.");
            // Declare a proxy to reference the hub.
            var expHub = $.connection.experimentHub;

            // Create a function that the hub can call to plot the data.
            expHub.client.pushLatestData = function (data) {

                //parse to send to plotting functions.
                var jData = JSON.parse(data);
                //Keep data and experimental parameters on screen:

                clearData();
                var plot = document.getElementById("plot");

                plotDataWithRightAxes(plot, jData);

            };

            expHub.client.pushAllDataToTextArea = function (data) {
                $('#rawData').val(data);
            };

            //The console, which the hub can call to print information
            expHub.client.toConsole = function (s) {
                $('#localconsole').val($('#localconsole').val() + '\n' + s);
                $('#localconsole').scrollTop($('#localconsole')[0].scrollHeight);
            };

            //This is called by the server once the mma Notebook is ready
            expHub.client.displayDownloadLink = function (link) {
                $('#downloadlink').attr({ href: link, target: '_blank' });
                //$('#downloadlink').attr("download", link.split('\\').pop());
                $('#downloadlink').show();
            };

            // Start the connection! Herein are start and stop functions, which interact with the experiment.
            $.connection.hub.start().done(function () {

                $('#startbutton').click(function () {

                    var expParams = getExperimentParameters();
                    //Getting plot ready.
                    initialisePlot(document.getElementById("plot"), expParams.ScanParams.ScanParameterName, expParams.DAQmx.AINames);

                    // Call the Start method on the hub.
                    expHub.server.startExperiment(JSON.stringify(getExperimentParameters()));

                });

                $('#stopbutton').click(function () {
                    // Call the Stop method on the hub.
                    expHub.server.stopExperiment();

                });

                $('#converttoddsunitsbutton').click(function () {
                     document.querySelector('#ScanStart').value =  document.querySelector('#ScanStart').value /  document.querySelector('#ExternalFactor').value;
                     document.querySelector('#ScanEnd').value = document.querySelector('#ScanEnd').value / document.querySelector('#ExternalFactor').value;

                });

                $('#clearplotbutton').click(function () {
                    //Clears data locally in browser
                    clearData();
                });

                $('#exportdatabutton').click(function () {
                    expHub.server.saveExperiment($('#exportformatselect').val());
                });

                $('#toevernotebutton').click(function () {
                    expHub.server.backupExperimentData();
                });

            });
        });

        //Clears data in plot
        var clearData = function () {
            deleteData(document.getElementById("plot"));
        };

        //Manipulating the data once it's taken.
        var copyButton = document.querySelector('#copydatabutton');
        copyButton.addEventListener('click', function (event) {
            var d = document.querySelector('#rawData');
            var range = document.createRange();
            range.selectNode(d);
            window.getSelection().addRange(range);

            var success_bool = document.execCommand('copy');

            window.getSelection().removeRange(range);
        });

        //Gets parameters on UI
        var getExperimentParameters = function () {
            //Stuff that doesn't change very often can be hardcoded here.
            var params = {
                'DAQmx': {
                    'AINames': ['dc', '1f', '2f'],
                    'AIAddresses': ['/dev1/ai1', '/dev1/ai2', '/dev1/ai3'],
                    'AutoStart': document.querySelector('#AutoStart').value,
                    'TriggerAddress': '/dev1/PFI0',
                    'SampleRate': 10000,
                    'NumberOfSamplesPerIntegrationTime': 1,
                    'LockinParams': {
                        'ModulationFrequency': document.querySelector('#ModulationFrequency').value,
                        'MaxModulationHarmonic': document.querySelector('#Harmonic').value,
                        'MustDemodulate': document.querySelector('#Demodulate').value
                    }
                },

                'DDS': {
                    'DDSAddress': 'ASRL4::INSTR'
                    //'DDSAddress': 'ASRL3:INSTR'
                },

                'ScanParams': {
                    'ScanStart': document.querySelector('#ScanStart').value,
                    'ScanEnd': document.querySelector('#ScanEnd').value,
                    'NumberOfPoints': document.querySelector('#NumberOfPoints').value,
                    'HoldValue': document.querySelector('#ScanHoldValue').value,
                    'Sleep': document.querySelector('#Sleep').value,
                    'ScanParameterName': 'Frequency [Hz]',
                },
                // Put all misc. parameters / comments / experimental conditions in here
                'ExternalParams': {
                    'Comments': "Empty comment",
                    'ExternalFactor' : document.querySelector('#ExternalFactor').value
                }

            };


            //Creates the ramp to send to the experiment.

            var makeScanParameterValues = function () {
                    //Creates the variables.
                var factor = parseFloat(params.ExternalParams.MultiplicationFactor);
                var start = parseFloat(params.ScanParams.ScanStart);
                var end = parseFloat(params.ScanParams.ScanEnd);
                var hold = parseFloat(params.ScanParams.HoldValue);
                var points = parseFloat(params.ScanParams.NumberOfPoints);

                    //DDS SCAN
                    if (document.querySelector('#ScanBool').value == "true") {
                        if ((start > 125 ) && (end < 275 )) {
                            params.ScanParams.ScanParameterValues = function () {
                                var vals = [], dv = (end - start) / points;
                                for (var i = 0; i < points/2; i++) {
                                    vals.push((2*i * dv + start)*1000000);
                                }
                                for (var i = 0; i < points/2; i++) {
                                    vals.push((end - 2*i * dv)*1000000);
                                }
                                return vals;
                            }();
                        }
					}

                    //DDS HOLD
                    else if (document.querySelector('#ScanBool').value == "false") {
                        if ((hold > 125 ) && (hold < 275 )) {
                            params.ScanParams.ScanParameterValues = function () {
                                var vals = [];
                                    for (var i = 0; i < points ; i++) {
                                        vals.push(hold * 1000000);
                                    }
                                    return vals;
                            }();
                        }
                    };
                    //params.ScanParams.ScanParameterName = 'Acquisition # (Fixed Frequency)';

                };
                makeScanParameterValues();
                return params;
            };


            //Creates the plot.
            var plotDataWithRightAxes = function (plot, jData) {
                    var params = getExperimentParameters();
                    if (document.querySelector('#xaxisselect').value == "DDS Frequency") {
                        updateXAxisLabel(plot, params.ScanParams.ScanParameterName)
                        appendData(plot, jData);
                    }

                    if (document.querySelector('#xaxisselect').value == "Frequency * External Factor") {
                        var axisName = params.ScanParams.ScanParameterName;
                        for (var i = 0; i <jData.length; i++) {
                            jData[i][axisName] = i*((parseFloat(params.ExternalParams.ExternalFactor)/1000)*((parseFloat(params.ScanParams.ScanEnd)- parseFloat(params.ScanParams.ScanStart)))
                                                    /parseFloat(params.ScanParams.NumberOfPoints))+(parseFloat(params.ExternalParams.ExternalFactor)*(parseFloat(params.ScanParams.ScanStart)/1000));
                        }
                        updateXAxisLabel(plot, "Frequency * External Factor [GHz]")
                        appendData(plot, jData);
                    }

                    else if (document.querySelector('#xaxisselect').value == "Acquisition Order") {
                        var axisName = getExperimentParameters().ScanParams.ScanParameterName;
                        for (var i = 0; i < jData.length; i++) {
                            jData[i][axisName] = i;
                        }
                        updateXAxisLabel(plot, "Acquisition Order")
                        appendData(plot, jData);
                    };
            };

    </script>
</body>
