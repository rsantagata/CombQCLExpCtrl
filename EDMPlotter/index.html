<!DOCTYPE html>
<meta charset="utf-8">

<head>
    <title>Parity crusher</title>
    <link rel="stylesheet" type="text/css" href="css/paritycrusherstyle.css">
    <!--Script references. -->
    <!--Reference the jQuery library. -->
    <script src="Scripts/jquery-2.2.3.min.js"></script>
    <!--Reference the SignalR library. -->
    <script src="Scripts/jquery.signalR-2.2.0.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="signalr/hubs"></script>
    <!--Add script to plot some data.-->
    <script src="https://cdn.plot.ly/plotly-latest.js"></script>
    <script src="js/plotlyplot2.js" type="text/javascript"></script>
</head>

<body>
    <header>Parity crusher</header>

    <section class="console">
        <article>
            <label>Console</label><br /><br />
            <textarea id="localconsole" style="width:100%; height:75px; border: 1px solid black" readonly></textarea>
        </article>
    </section>

    <section class="controlpanel">

        <article id="startstopcontainer">
            <label>Experiment Control</label><br />
            <input type="button" id="startbutton" value="Start" />
            <input type="button" id="stopbutton" value="Stop" />
        </article>

        <article id="scanparamscontainer">
            <label>Scan Parameters</label><br />
            <form name="scanparamsform" id="scanparamsform">
                Scan:
                <select name="ScanBool" id="ScanBool">
                    <option selected>true</option>
                    <option>false</option>
                </select>
                <br />
                Number of points:
                <input type="text" name="NumberOfPoints" id="NumberOfPoints" value="100">
                <br>
                Start:
                <input type="text" name="ScanStart" id="ScanStart" value="1">
                <br>
                End:
                <input type="text" name="ScanEnd" id="ScanEnd" value="101">
                <br>
                Hold Value (if not scanning):
                <input type="text" name="ScanHoldValue" id="ScanHoldValue" value="2">
                <br>
                Sample loop rest interval (ms):
                <input type="text" name="Sleep" id="Sleep" value="5">
                <br>
                <label>
                    <input type="checkbox" name="eosstopcheckbox" id="eosstopcheckbox" value="eosStop" />Stop on end-of-Scan
                </label>
            </form>
        </article>

        <article id="daqmxparamscontainer">
            <label>DAQmx Parameters</label><br />
            <form name="daqmxparamsform" id="daqmxexpparamsform">
                Auto-trigger:
                <select name="AutoStart" id="AutoStart">
                    <option selected>true</option>
                    <option>false</option>                    
                </select>
            </form>
        </article>

        <article id="lockincontainer">
            <label>Lock-in Parameters</label><br />
            <form name="lockinparamsform" id="lockinparamsform">
                Demodulate signal:
                <select name="demodulate" id="Demodulate">
                    <option>true</option>
                    <option selected>false</option>
                </select>
                <br>
                Modulation frequency:
                <input type="text" name="ModulationFrequency" id="ModulationFrequency" value="1000">
                <br>
                Max harmonic:
                <input type="text" name="harmonic" id="Harmonic" value="1">
                <br>
            </form>
        </article>

    </section>

    <section class="datadisplay">

        <article>
            <article class="plot" id="plot"></article>
            <input type="button" id="clearbutton" value="Clear" />
        </article>

        <article>
            <label>Save/Export</label><br /><br />
            <input type="button" id="toevernotebutton" value="Backup to Evernote" />
            <input type="button" id="exportdatabutton" value="Export to" />
            <select name="exportformatselect" id="exportformatselect">
                <option selected>JSON</option>
                <option>Mathematica</option>
                <option>CSV</option>
                <option>TSV</option>
            </select>
            <input type="button" id="copydatabutton" value="Copy to clipboard" />
            <br>
            <a id="downloadlink" href="" target="_blank" hidden>Data ready for export: right-click here & select "Save target as" to download.</a><br />
            <textarea id="rawData" style="width: 90%; height:100px; padding: 2px; border: 1px solid black" readonly></textarea>
        </article>

    </section>




    <script type="text/javascript">

        $(function () {

            $('#localconsole').val("Hi! Connecting to experiment now. Please wait.");
            // Declare a proxy to reference the hub.
            var expHub = $.connection.experimentHub;

            //Getting plot ready.
            initialisePlot(document.getElementById("plot"), getExperimentParameters());


            // Create a function that the hub can call to plot the data.
            expHub.client.pushLatestData = function (data) {

                //parse to send to plotting functions.
                var jData = JSON.parse(data);
                //Keep data and experimental parameters on screen:

                clearData();
                var plot = document.getElementById("plot");
                appendData(plot, jData);


            };

            expHub.client.pushAllDataToTextArea = function (data) {
                $('#rawData').val(data);
            };

            //The console, which the hub can call to print information
            expHub.client.toConsole = function (s) {
                $('#localconsole').val($('#localconsole').val() + '\n' + s);
                $('#localconsole').scrollTop($('#localconsole')[0].scrollHeight);
            };

            //This is called by the server once the mma Notebook is ready
            expHub.client.displayDownloadLink = function (link) {
                $('#downloadlink').attr({ href: link, target: '_blank' });
                //$('#downloadlink').attr("download", link.split('\\').pop());
                $('#downloadlink').show();
            };

            // Start the connection! Herein are start and stop functions, which interact with the experiment.
            $.connection.hub.start().done(function () {

                $('#startbutton').click(function () {
                    // Call the Start method on the hub.
                    expHub.server.startExperiment(JSON.stringify(getExperimentParameters()));

                });

                $('#stopbutton').click(function () {
                    // Call the Stop method on the hub.
                    expHub.server.stopExperiment();

                });

                $('#clearbutton').click(function () {
                    //Clears data locally in browser
                    clearData();
                });

                $('#exportdatabutton').click(function () {
                    expHub.server.saveExperiment($('#exportformatselect').val());
                });

                $('#toevernotebutton').click(function () {
                    expHub.server.backupExperimentData();
                });

            });
        });

        //Clears data in plot
        var clearData = function () {
            deleteData(document.getElementById("plot"));
        };

        //Manipulating the data once it's taken.
        var copyButton = document.querySelector('#copydatabutton');
        copyButton.addEventListener('click', function (event) {
            var d = document.querySelector('#rawData');
            var range = document.createRange();
            range.selectNode(d);
            window.getSelection().addRange(range);

            var success_bool = document.execCommand('copy');

            window.getSelection().removeRange(range);
        });

        //Gets parameters on UI
        var getExperimentParameters = function () {
            //Stuff that doesn't change very often can be hardcoded here.
            var params = {
                'DAQmx': {
                    'AINames': ['dc', '1f', '2f'],
                    'AIAddresses': ['/dev1/ai1', '/dev1/ai2', '/dev1/ai3'],
                    'AutoStart': document.querySelector('#AutoStart').value,
                    'TriggerAddress': '/dev1/PFI0',
                    'SampleRate': 10000,
                    'NumberOfSamplesPerIntegrationTime': 1,
                    'LockinParams': {
                        'ModulationFrequency': document.querySelector('#ModulationFrequency').value,
                        'MaxModulationHarmonic': document.querySelector('#Harmonic').value,
                        'MustDemodulate': document.querySelector('#Demodulate').value
                    }
                },

                'DDS': {
                    'DDSAddress': 'ASRL3::INSTR'
                },

                'ScanParams': {
                    'NumberOfPoints': document.querySelector('#NumberOfPoints').value,
                    'Sleep': document.querySelector('#Sleep').value,
                    'ScanParameterName': 'frequency',
                }
            };

            //Creates the ramp to send to the experiment.
            var makeScanParameterValues = function () {
                if (document.querySelector('#ScanBool').value) {    
                    var start = document.querySelector('#ScanStart').value;
                    var end = document.querySelector('#ScanEnd').value;
                    params.ScanParams.ScanParameterValues = function () {
                        var vals = [], dv = (end - start)/params.ScanParams.NumberOfPoints;
                        for(var i = 0; i < params.ScanParams.NumberOfPoints; i++)
                        {
                            vals.push(i * dv);
                        }
                        return vals;
                    }();
                }
                else {
                    params.ScanParams.ScanParameterValues = function () {
                        var vals = [];
                        for (var i = 0; i < params.ScanParams.NumberOfPoints; i++) {
                            vals.push(document.querySelector('#ScanHoldValue').value);
                        }
                        return vals;
                    }();
                    params.ScanParams.ScanParameterName = 'index';
                }
            };
            makeScanParameterValues();
            return params;
        };


    </script>
</body>
