<!DOCTYPE html>
<meta charset="utf-8">

<head>
    <title>Experiment Control Panel</title>
    <link rel="stylesheet" type="text/css" href="css/containerstyle.css">
    <link rel="stylesheet" type="text/css" href="css/controlpanelstyle.css">
    <link rel="stylesheet" type="text/css" href="css/consoleboxstyle.css">
    <!--Script references. -->
    <!--Reference the jQuery library. -->
    <script src="Scripts/jquery-2.2.3.min.js"></script>
    <!--Reference the SignalR library. -->
    <script src="Scripts/jquery.signalR-2.2.0.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="signalr/hubs"></script>
    <!--Add script to plot some data.-->
    <script src="https://cdn.plot.ly/plotly-latest.js"></script>
    <script src="js/plotlyplot2.js" type="text/javascript"></script>
</head>

<body>
    <div class="controlpanel">
        <label>Experiment Control</label><br /><br />
        <input type="button" id="startbutton" value="Start" />
        <input type="button" id="stopbutton" value="Stop" />
    </div>
    <div class="controlpanel">
        <label>Experiment Parameters</label><br /><br />
        <form name="ExpParams" id="ExpParams">
            Auto-trigger:
            <br>
            <select name="AutoStart" id="AutoStart">
                <option>false</option>
                <option selected>true</option>
            </select>
            <br> Number of points:
            <br>
            <input type="text" name="NumberOfPoints" id="NumberOfPoints" value="100">
            <br> Sample loop rest interval (ms):
            <br>
            <input type="text" name="Sleep" id="Sleep" value="5">
            <br>
            <label>
                <input type="checkbox" name="eosstopcheckbox" id="eosstopcheckbox" value="eosStop" />Stop on end-of-Scan
            </label>
        </form>
    </div>
    <div class="consolebox">
        <label>Console</label><br /><br />
        <textarea id="localconsole" style="width: 1000px; height:100px; padding: 2px; border: 1px solid black" readonly></textarea>
    </div>
    <div class="container">
        <div id="plot" style="left:10%;height:auto;width:80%;"></div>
        <input type="button" id="clearbutton" value="Clear" />
    </div>
    <div class="container">
        <label>Save/Export</label><br /><br />
        <input type="button" id="savedatabutton" value="Export to" />
        <select name="exportformatselect" id="exportformatselect">
            <option selected>JSON</option>
            <option>Mathematica</option>
            <option>CSV</option>
            <option>TSV</option>
        </select>
        <input type="button" id="copydatabutton" value="Copy to clipboard" />
        <br>
        <a id="downloadlink" href="" target="_blank" hidden>Data ready for export: Click to download.</a>
        <textarea class="rawData" id="rawData" style="width: 1000px; height:100px; padding: 2px; border: 1px solid black" readonly></textarea>
    </div>

    <script type="text/javascript">

        $(function () {

            $('#localconsole').val("Hi! Connecting to experiment now. Please wait.");

            //Getting plot ready.
            initialisePlot(document.getElementById("plot"), getExperimentParameters());

            // Declare a proxy to reference the hub.
            var pHub = $.connection.plotHub;

            // Create a function that the hub can call to plot the data.
            pHub.client.pushLatestData = function (data) {

                //parse to send to plotting functions.
                var jData = JSON.parse(data);
                //Keep data and experimental parameters on screen:
                
                clearData();
                appendData(document.getElementById("plot"), jData);

            };

            pHub.client.pushAllDataToTextArea = function (data) {
                $('#rawData').val(data);
            };

            //The console, which the hub can call to print information
            pHub.client.toConsole = function (s) {
                $('#localconsole').val($('#localconsole').val() + '\n' + s);
                $('#localconsole').scrollTop($('#localconsole')[0].scrollHeight);
            };

            //This is called by the server once the mma Notebook is ready
            pHub.client.displayDownloadLink = function (link) {
                $('#downloadlink').attr({href : link, target : '_blank'});
                //$('#downloadlink').attr("download", link.split('\\').pop());
                $('#downloadlink').show();
            };

            // Start the connection! Herein are start and stop functions, which interact with the experiment.
            $.connection.hub.start().done(function () {

                $('#startbutton').click(function () {
                    // Call the Start method on the hub.
                    pHub.server.startExperiment(JSON.stringify(getExperimentParameters()));

                });

                $('#stopbutton').click(function () {
                    // Call the Stop method on the hub.
                    pHub.server.stopExperiment();

                });

                $('#clearbutton').click(function () {
                    //Clears data locally in browser
                    clearData();
                });

                $('#savedatabutton').click(function () {
                    pHub.server.saveExperiment($('#exportformatselect').val());
                });

            });
        });

        //Clears data in plot
        var clearData = function () {
            deleteData(document.getElementById("plot"));
        };

        //Manipulating the data once it's taken.
        var copyButton = document.querySelector('#copydatabutton');
        copyButton.addEventListener('click', function (event) {
            var d = document.querySelector('#rawData');
            var range = document.createRange();
            range.selectNode(d);
            window.getSelection().addRange(range);

            var success_bool = document.execCommand('copy');

            window.getSelection().removeRange(range);
        });


        //Gets parameters on UI
        var getExperimentParameters = function () {
            //Stuff that doesn't change very often can be hardcoded here.
            var params = {
                'NumberOfPoints': document.querySelector('#NumberOfPoints').value,
                'AINames': ['dc', '1f', '2f'],
                'AIAddresses': ['/dev1/ai1', '/dev1/ai2', '/dev1/ai3'],
                'AutoStart': document.querySelector('#AutoStart').value,
                'TriggerAddress': '/dev1/PFI0',
                'Sleep': document.querySelector('#Sleep').value,
                'DDSAddress': 'ASRL3::INSTR',
                'ScanParameter': 'frequency'
            };
            return params;
        }
    </script>
</body>
