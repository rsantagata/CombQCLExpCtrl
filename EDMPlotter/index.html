<!DOCTYPE html>
<meta charset="utf-8">

<head>
    <title>Experiment Control Panel</title>
    <link rel="stylesheet" type="text/css" href="css/containerstyle.css">
    <link rel="stylesheet" type="text/css" href="css/controlpanelstyle.css">
    <link rel="stylesheet" type="text/css" href="css/consoleboxstyle.css">
    <link rel="stylesheet" type="text/css" href="css/d3plotstyle.css">
    <!--Script references. -->
    <!--Reference the jQuery library. -->
    <script src="Scripts/jquery-2.2.3.min.js"></script>
    <!--Reference the SignalR library. -->
    <script src="Scripts/jquery.signalR-2.2.0.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="signalr/hubs"></script>
    <!--Add script to plot some data.-->
    <script src="https://cdn.plot.ly/plotly-latest.js"></script>
    <script src="js/plotlyplot2.js" type="text/javascript"></script>
</head>

<body>
    <div class="controlpanel">
        <input type="button" id="startbutton" value="Start" />
        <input type="button" id="stopbutton" value="Stop" />
        <input type="button" id="copydatabutton" value="Copy to clipboard" />
        <input type="button" id="clearbutton" value="Clear" />
        <input type="button" id="savedatabutton" value="Save to" />
        <input type="text" id="savepathtextbox" value="C:\data\data.csv" />
        <label>
            <input type="checkbox" name="eosautosavecheckbox" id="eosautosavecheckbox" value="eosStop" />Autosave on end-of-Scan
        </label>
    </div>
    <div class="controlpanel">
        <form name="ExpParams" id="ExpParams">
            Auto-trigger:
            <br>
            <select name="AutoStart" id="AutoStart">
                <option>false</option>
                <option selected>true</option>
            </select>
            <br> Number of points:
            <br>
            <input type="text" name="NumberOfPoints" id="NumberOfPoints" value="100">
            <br> Sample loop rest interval (ms):
            <br>
            <input type="text" name="Sleep" id="Sleep" value="5">
            <br>
            <label>
                <input type="checkbox" name="eosstopcheckbox" id="eosstopcheckbox" value="eosStop" />Stop on end-of-Scan</label>
        </form>
    </div>
    <div class="consolebox">
        <textarea id="localconsole" style="width: 1000px; height:100px; padding: 2px; border: 1px solid black" readonly></textarea>
    </div>
    <div class="container">
        <div id="plot" style="left:10%;height:auto;width:80%;"></div>
    </div>
    <div class="container">
        <textarea class="rawData" id="rawData" style="width: 1000px; height:100px; padding: 2px; border: 1px solid black" readonly></textarea>
    </div>

    <script type="text/javascript">
    //The main script.
    $(function() {

        //Stuff that doesn't change very often.
        var fixedParams = {
                'ScanParameter': 'frequency',
                'AINames': ['dc', '1f', '2f'],
                'AIAddresses': ['/dev1/ai1', '/dev1/ai2', '/dev1/ai3'],
                'TriggerAddress': '/dev1/PFI0',
                'DDSAddress': 'ASRL3::INSTR'
            }
            //Initially:
        var plotContainsData = false;

        $('#localconsole').val("Hi! Connecting to experiment now. Please wait.");

        //Getting plot ready.
        initialisePlot(document.getElementById("plot"), fixedParams);

        // Declare a proxy to reference the hub.
        var pHub = $.connection.plotHub;

        // Create a function that the hub can call to plot the data.
        pHub.client.pushData = function(data) {
            //To see raw data:
            //pHub.client.toConsole(data);

            //Keep data on div:
            $('#rawData').val(data)

            //parse to send to plotting functions.
            var jData = JSON.parse(data);

            pHub.client.clearData();
            appendData(document.getElementById("plot"), jData);

            //a little cheezy, but keeps track of if data is appearing on screen.
            plotContainsData = true;

        };

        //This gets called by several things: the browser UI clear button (via c#, in case we ever want the c# to know about it) and the pushData function when new data arrives (otherwise old data doesn't get cleared)
        pHub.client.clearData = function() {
            if (plotContainsData) {
                deleteData(document.getElementById("plot"));
                plotContainsData = false;
            }
        };

        //The console
        pHub.client.toConsole = function(s) {
            $('#localconsole').val($('#localconsole').val() + '\n' + s);
            $('#localconsole').scrollTop($('#localconsole')[0].scrollHeight);
        };

        // Start the connection! Herein are start, stop, clear and save functions, which interact with the experiment.
        $.connection.hub.start().done(function() {

            $('#startbutton').click(function() {

                var params = {
                    'NumberOfPoints': document.querySelector('#NumberOfPoints').value,
                    'AINames': fixedParams.AINames,
                    'AIAddresses': fixedParams.AIAddresses,
                    'AutoStart': document.querySelector('#AutoStart').value,
                    'TriggerAddress': fixedParams.TriggerAddress,
                    'Sleep': document.querySelector('#Sleep').value,
                    'eosStop': document.querySelector('#eosstopcheckbox').checked,
                    'eosSave': document.querySelector('#eosautosavecheckbox').checked,
                    'savePath': document.querySelector('#savepathtextbox').value,
                    'DDSAddress': fixedParams.DDSAddress,
                    'ScanParameter' : fixedParams.ScanParameter
                };

                // Call the Start method on the hub.
                pHub.server.start(JSON.stringify(params));

            });

            $('#stopbutton').click(function() {
                // Call the Stop method on the hub.
                pHub.server.stop();

            });

            $('#clearbutton').click(function() {
                //Clears data locally in browser
                pHub.client.clearData();

            });

            $('#savedatabutton').click(function() {
                pHub.server.save($('#savepathtextbox').val());
            });

        });

    });
    </script>
    <script>
        var copyButton = document.querySelector('#copydatabutton');
        copyButton.addEventListener('click', function(event) {
            var d = document.querySelector('#rawData');
            var range = document.createRange();
            range.selectNode(d);
            window.getSelection().addRange(range);

            var success_bool = document.execCommand('copy');

            window.getSelection().removeRange(range);
        });
    </script>
</body>

